name: CodeQL

on:
  push:
    branches: [ "main" ]
    paths:
      - '**/*.py'
  pull_request:
    branches: [ "main" ]
    paths:
      - '**/*.py'
  schedule:
    - cron: "0 3 * * 1" # Mondays 03:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  analyze:
    name: CodeQL (Python)
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - id: detect
        name: Detect Python sources
        shell: bash
        run: |
          if git ls-files '*.py' | grep -q .; then
            echo "has_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_py=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL
        if: steps.detect.outputs.has_py == 'true'
        uses: github/codeql-action/init@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4.30.8
        with:
          languages: python
          queries: +security-extended

      - name: Perform CodeQL Analysis
        if: steps.detect.outputs.has_py == 'true'
        uses: github/codeql-action/analyze@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4.30.8
        with:
          category: "/language:python"

      - name: Skip (no Python files)
        if: steps.detect.outputs.has_py != 'true'
        run: echo "No Python files found; skipping CodeQL."
